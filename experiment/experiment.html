<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Word Identification Study</title>
<style>
  body { font-family: sans-serif; background:#f5f5f5; margin:0; padding:20px; }
  .card { background:white; border-radius:8px; padding:20px; max-width:900px; margin:0 auto; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
  h1 { font-size:24px; margin-top:0; }
  .btn { padding:10px 16px; border:none; border-radius:6px; cursor:pointer; margin-right:8px; }
  .btn-primary { background:#007acc; color:white; }
  .btn-primary:disabled { background:#a0aec0; color:#e2e8f0; cursor:not-allowed; }
  .btn-secondary { background:#ccc; color:black; }
  
  /* Play button styling for trials */
  #playBtn { display:block; margin:0 auto 20px; padding:14px 32px; font-size:18px; font-weight:600; }
  .hidden { display:none; }
  .progress { height:8px; background:#eee; border-radius:4px; margin:10px 0; overflow:hidden; }
  .progress > div { height:100%; background:#007acc; width:0; transition:width .2s ease; }
  textarea { width:100%; height:100px; margin-top:8px; padding:6px; border-radius:4px; border:1px solid #ccc; font-family:sans-serif; }
  .question-block { margin:20px 0; padding:12px; background:#f9f9f9; border-radius:6px; border:1px solid #ddd; }
  .question-block p { margin:0 0 8px 0; font-weight:bold; }
  input[type="text"] { width:100%; padding:8px; font-size:14px; border:1px solid #ccc; border-radius:6px; }

  /* Two-choice layout */
  .choices { display:flex; gap:14px; margin-top:14px; }
  .choice-btn {
    flex:1;
    padding:18px 14px;
    font-size:22px;
    font-weight:700;
    border-radius:10px;
    border:1px solid #ddd;
    background:#fafafa;
    cursor:pointer;
  }
  .choice-btn:disabled { opacity:0.6; cursor:not-allowed; }
  .choice-btn { display:none; }
  .image-container img { cursor:pointer; transition:transform 0.1s, box-shadow 0.1s; }
  .image-container img:hover { transform:scale(1.05); box-shadow:0 4px 12px rgba(0,0,0,0.2); }
  .image-container img:active { transform:scale(0.98); }
  .meta { margin-top:20px; color:#555; font-size:13px; text-align:center; }
  #trialStatus { font-size:18px; font-weight:600; color:#333; margin-top:24px; }
  .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; border:1px solid #ddd; background:#f7f7f7; padding:2px 6px; border-radius:6px; }

  /* Image pair display */
  .image-pair { display:flex; gap:20px; margin:20px 0; justify-content:center; align-items:flex-start; }
  .image-container { text-align:center; }
  .image-container img { max-width:200px; max-height:200px; border-radius:8px; border:2px solid #ddd; }
  .image-label { margin-top:8px; font-weight:bold; color:#333; }
</style>
</head>
<body>

<!-- Consent -->
<div class="card" id="screen-consent">
  <h1>Intro and Consent</h1>
  <p>Thank you for participating! You will listen to short audio clips and choose which word you heard.</p>
  <p><strong>Important:</strong> Please wear <strong>headphones</strong> for the entire experiment.</p>
  <p>
    Before starting, please read the
    <!-- Repo structure: /pharylary/experiment/ -> ../consent/ -->
    <a href="../consent/approved_consent_prolific.pdf" target="_blank" rel="noopener noreferrer">
      Informed Consent Form
    </a>
    then check the box below once done.
  </p>

  <label><input type="checkbox" id="consentCheck"> I consent to participate</label>
  <br><br>

  <label for="prolificId"><strong>Please enter your Prolific ID:</strong></label><br>
  <input type="text" id="prolificId" placeholder="e.g., 60a1b2c3d4e5f6g7h8i9" style="width:100%; padding:8px; font-size:14px; margin-top:6px;">
  <br><br>

  <button class="btn btn-primary" id="consentBtn" disabled>Continue</button>
</div>

<!-- Headphone Info -->
<div class="card hidden" id="screen-headphones">
  <h1>Headphone Information</h1>
  <p><strong>Before continuing:</strong> Please ensure you are wearing headphones.</p>
  <p>For our records, please tell us what type of headphones you are using (e.g., AirPods, wired earbuds, over-ear headphones).</p>

  <div>
    <label><strong>Please type the name or description of your headphones below:</strong></label>
    <input type="text" id="headphoneInput" placeholder="e.g., Apple AirPods Pro, Wired Sony Over-Ear">
  </div>

  <div style="margin-top:12px;">
    <label><input type="checkbox" id="confirmHeadphones"> I confirm that I am wearing headphones</label>
  </div>
  <br>
  <button class="btn btn-primary" id="headphoneNextBtn" disabled>Continue</button>
</div>

<!-- Volume Check -->
<div class="card hidden" id="screen-volume">
  <h1>Audio Volume Check</h1>
  <p>Set your device volume to a <strong>comfortable</strong> level.</p>
  <p>Press play to hear a short test sound. You may replay as many times as you wish.</p>

  <button class="btn btn-primary" id="playVolumeCheckBtn">Play Test Audio</button>
  <audio id="volumeCheckAudio" preload="auto"></audio>

  <p style="margin-top:16px; color:#555; font-size:14px;">
    When you can clearly hear the audio, click <strong>Continue</strong>.
  </p>

  <button class="btn btn-primary" id="volumeNextBtn" disabled>Continue</button>
</div>

<!-- Audio Attention Check -->
<div class="card hidden" id="screen-audiocheck">
  <h1>Audio Check</h1>
  <button class="btn btn-primary" id="playAudioCheckBtn">Play Audio</button>
  <audio id="audioCheckPlayer"></audio>

  <div class="question-block">
    <p>Play the audio and type the answer you heard:</p>
    <input type="text" id="audioCheckResponse" style="width:300px; padding:6px;">
  </div>

  <button class="btn btn-primary" id="audioCheckNextBtn" disabled>Continue</button>
</div>

<!-- Trials -->
<div class="card hidden" id="screen-trials">
  <div class="progress"><div id="progressBar"></div></div>
  <h1 id="trialTitle">Trial</h1>
  <p>
    Press <strong>spacebar</strong> to play the audio. After it ends, click an image or press <strong>F</strong> (left) / <strong>J</strong> (right) to choose.
  </p>

  <button class="btn btn-primary" id="playBtn">Play Audio</button>
  <audio id="player" preload="auto"></audio>

  <div class="image-pair" id="imagePair">
    <div class="image-container" id="leftImageContainer"></div>
    <div class="image-container" id="rightImageContainer"></div>
  </div>

  <div class="choices" style="margin-top:14px;">
    <button class="choice-btn" id="leftBtn" disabled></button>
    <button class="choice-btn" id="rightBtn" disabled></button>
  </div>

  <div class="meta" id="trialStatus">Waiting to start…</div>
</div>

<!-- Feedback -->
<div class="card hidden" id="screen-feedback">
  <h1>Final Feedback (optional)</h1>
  <textarea id="feedbackText" placeholder="Any comments about the task?"></textarea>
  <button class="btn btn-primary" id="feedbackNextBtn">Submit</button>
</div>

<!-- Finish -->
<div class="card hidden" id="screen-finish">
  <h1>All Done!</h1>
  <p>Thank you for participating in this study.</p>
  <p><strong>Your participation code:</strong> <code id="completionCode">CJUVEL1D</code></p>
  <p>
    Please click the link below to complete your submission on Prolific:
  </p>
  <p>
    <a id="prolificReturnLink" href="https://app.prolific.com/submissions/complete?cc=CJUVEL1D" target="_blank" style="font-size:16px; color:#007acc; text-decoration:underline;">
      ➤ Click here to return to Prolific and submit your study
    </a>
  </p>
</div>

<script>
/* ===========================
   CONFIG
=========================== */

/** Google Apps Script endpoint (same as your template) */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxblhxJ34A7WfooWQBdKIdzPLMpyPfbOWnHmNdGsbWXa72ZxqYIR-2gaMa8jV7jnRcebw/exec";

/** Repo structure:
 *  - This file is /pharylary/experiment/index.html
 *  - Audio is /pharylary/data/audio/
 *  - Images are /pharylary/data/images/
 *  - Trials CSV is /pharylary/data/trials.csv
 *  - Attention check audio is /pharylary/experiment/audio_check/
 *  - Volume check audio can also live in /pharylary/experiment/audio_check/
 */
const CONFIG = {
  audioBase: "../data/audio",          // from /experiment/ to /data/audio/
  audioSuffix: ".wav",
  imageBase: "../data/images",         // from /experiment/ to /data/images/
  // Use relative path for local testing with Live Server
  // Use GitHub raw URL when deployed to GitHub Pages
  trialsUrl: "../data/trials.csv",     // Change to GitHub raw URL when deploying
  attnBase: "./audio_check",           // inside /experiment/audio_check/
  nAttentionFiles: 21,                // 1..21 wav files
  volumeCheckFile: "./audio_check/gone_b.wav", // put this file in experiment/audio_check/
  attentionEveryNTrials: 4,            // show an attention check every N trials
  completionCode: "CJUVEL1D",
  prolificReturnUrl: "https://app.prolific.com/submissions/complete?cc=CJUVEL1D",
};

/** Trials: Loaded from CSV
 *  CSV should have columns: TargetWordAudioFile, TargetWordImageFile, DistractorWordImageFile
 *  Each row becomes one trial.
 *  Target and distractor images are randomly assigned to left/right for each trial.
 */
let TRIALS = [];

/* ===========================
   STATE
=========================== */
const State = {
  participantId: null,      // Prolific ID
  headphoneType: "",
  trialIndex: 0,
  audioOffsetTs: null,      // performance.now() at audio offset
  awaitingChoice: false,
  attnQueue: [],
  attnAnswers: [],
  rowsLocal: [],            // optional local copy
};

/* ===========================
   HELPERS
=========================== */
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function nowMs(){ return performance.now(); }
function randomBoolean(){ return Math.random() > 0.5; }

function sendToGoogleSheet(obj){
  const fd = new FormData();
  for (const k in obj) fd.append(k, obj[k] ?? "");
  fetch(SCRIPT_URL, { method:"POST", body:fd }).catch(err=>console.error("Sheet POST error:", err));
}

function show(id){ document.getElementById(id).classList.remove("hidden"); }
function hide(id){ document.getElementById(id).classList.add("hidden"); }

function currentTrial(){ return TRIALS[State.trialIndex]; }
function resolveAudioUrl(trial){
  // allow either audio_file or audio_url; prefer audio_url if provided
  if(trial.audio_file) return `${CONFIG.audioBase}/${trial.audio_file}`;
  return trial.audio_url || "";
}
function resolveImageUrl(filename){
  // resolve image filename to full path
  return `${CONFIG.imageBase}/${filename}`;
}

/* ===========================
   CSV PARSING & TRIAL SETUP
=========================== */
function parseCSV(text){
  const lines = text.trim().split('\n');
  if(lines.length < 2) return [];
  
  // Parse header row
  const headerLine = lines[0];
  const headers = headerLine.split(',').map(h => h.trim());
  
  // Find column indices for required fields
  const targetAudioIdx = headers.indexOf('TargetWordAudioFile');
  const targetImageIdx = headers.indexOf('TargetWordImageFile');
  const distractorImageIdx = headers.indexOf('DistractorWordImageFile');
  
  if(targetAudioIdx === -1 || targetImageIdx === -1 || distractorImageIdx === -1){
    console.error('CSV missing required columns');
    return [];
  }
  
  // Parse data rows
  const trials = [];
  for(let i = 1; i < lines.length; i++){
    const line = lines[i].trim();
    if(!line) continue; // skip empty lines
    
    const cells = line.split(',').map(c => c.trim());
    const audioFile = cells[targetAudioIdx] || '';
    const targetImage = cells[targetImageIdx] || '';
    const distractorImage = cells[distractorImageIdx] || '';
    
    if(!audioFile || !targetImage || !distractorImage) continue;
    
    // Randomly assign target/distractor to left/right
    const targetLeft = randomBoolean();
    
    // Capture all other columns as custom data
    const customData = {};
    for(let j = 0; j < headers.length; j++){
      if(j !== targetAudioIdx && j !== targetImageIdx && j !== distractorImageIdx){
        customData[headers[j]] = cells[j] || '';
      }
    }
    
    const trial = {
      trial_id: i,
      audio_file: audioFile,
      target_image: targetImage,
      distractor_image: distractorImage,
      target_side: targetLeft ? "left" : "right",
      left_image: targetLeft ? targetImage : distractorImage,
      right_image: targetLeft ? distractorImage : targetImage,
      ...customData  // Spread custom columns into trial object
    };
    
    trials.push(trial);
  }
  
  return trials;
}

async function loadTrialsFromCSV(){
  try {
    const response = await fetch(CONFIG.trialsUrl);
    if(!response.ok) throw new Error(`Failed to load CSV: ${response.statusText}`);
    
    const csvText = await response.text();
    TRIALS = parseCSV(csvText);
    
    if(TRIALS.length === 0){
      alert("No valid trials found in CSV file. Check the file format and column names.");
      return false;
    }
    
    console.log(`Loaded ${TRIALS.length} trials from CSV`);
    return true;
  } catch (err) {
    console.error('CSV load error:', err);
    alert("Failed to load trials from CSV file. Check the browser console for details.");
    return false;
  }
}

/* ===========================
   CONSENT + HEADPHONES
=========================== */
const consentCheck = document.getElementById('consentCheck');
const prolificInput = document.getElementById('prolificId');
const consentBtn = document.getElementById('consentBtn');

function updateConsentContinue(){
  consentBtn.disabled = !(consentCheck.checked && prolificInput.value.trim().length > 0);
}
consentCheck.onchange = updateConsentContinue;
prolificInput.oninput  = updateConsentContinue;

consentBtn.onclick = () => {
  const idVal = prolificInput.value.trim();
  if(!idVal){ alert("Please enter your Prolific ID before continuing."); return; }
  State.participantId = idVal;
  
  // Load trials from CSV before proceeding
  consentBtn.disabled = true;
  consentBtn.textContent = "Loading trials...";
  
  loadTrialsFromCSV().then(success => {
    if(success){
      hide("screen-consent");
      show("screen-headphones");
    }
    consentBtn.disabled = false;
    consentBtn.textContent = "Continue";
  });
};

const headphoneInput = document.getElementById('headphoneInput');
const confirmHeadphones = document.getElementById('confirmHeadphones');
const headphoneNextBtn = document.getElementById('headphoneNextBtn');

function updateHeadphoneContinue(){
  headphoneNextBtn.disabled = !(headphoneInput.value.trim() && confirmHeadphones.checked);
}
headphoneInput.oninput = updateHeadphoneContinue;
confirmHeadphones.onchange = updateHeadphoneContinue;

headphoneNextBtn.onclick = () => {
  State.headphoneType = headphoneInput.value.trim();
  hide("screen-headphones");
  show("screen-volume");
};

/* ===========================
   VOLUME CHECK
=========================== */
const volumeAudio = document.getElementById('volumeCheckAudio');
const playVolumeBtn = document.getElementById('playVolumeCheckBtn');
const volumeNextBtn = document.getElementById('volumeNextBtn');

volumeAudio.src = CONFIG.volumeCheckFile;

playVolumeBtn.onclick = async () => {
  try {
    await volumeAudio.play();
    volumeNextBtn.disabled = false;
    playVolumeBtn.textContent = "Playing...";
    playVolumeBtn.disabled = true;
  } catch (err) {
    alert("Unable to start audio playback. Please check browser permissions and try again.");
    playVolumeBtn.disabled = false;
    playVolumeBtn.textContent = "Play Test Audio";
  }
};
volumeAudio.onended = () => {
  playVolumeBtn.textContent = "Replay Audio";
  playVolumeBtn.disabled = false;
};
volumeNextBtn.onclick = () => {
  volumeAudio.pause();
  hide("screen-volume");
  prepareAttentionQueue();
  showAudioAttentionCheck(() => startTrials());
};

/* ===========================
   ATTENTION CHECKS
=========================== */
function prepareAttentionQueue(){
  const urls=[];
  for(let i=1;i<=CONFIG.nAttentionFiles;i++){
    urls.push(`${CONFIG.attnBase}/${i}.wav`);
  }
  State.attnQueue = shuffle(urls);
}
function nextAttentionAudio(){
  if(State.attnQueue.length===0) prepareAttentionQueue();
  return State.attnQueue.shift();
}

function showAudioAttentionCheck(onContinue){
  const card = document.getElementById('screen-audiocheck');
  const playBtn = document.getElementById('playAudioCheckBtn');
  const audio   = document.getElementById('audioCheckPlayer');
  const input   = document.getElementById('audioCheckResponse');
  const nextBtn = document.getElementById('audioCheckNextBtn');

  input.value = "";
  nextBtn.disabled = true;

  playBtn.disabled = false;
  playBtn.textContent = "Play Audio";

  audio.src = nextAttentionAudio();
  audio.currentTime = 0;

  playBtn.onclick = async () => {
    try {
      playBtn.disabled = true;
      playBtn.textContent = "Playing...";
      await audio.play();
    } catch {
      alert("Please check your browser audio permissions.");
      playBtn.disabled = false;
      playBtn.textContent = "Play Audio";
    }
  };

  audio.onended = () => {
    playBtn.textContent = "Audio finished";
    playBtn.disabled = true;
  };

  input.oninput = () => { nextBtn.disabled = !input.value.trim(); };

  nextBtn.onclick = () => {
    const ans = input.value.trim();
    if(!ans){ alert("Please type your answer before continuing."); return; }
    State.attnAnswers.push(ans);

    // optionally send attention check row immediately
    sendToGoogleSheet({
      participant_id: State.participantId,
      prolific_id: State.participantId,
      block: "AttentionCheck",
      attention_index: State.attnAnswers.length,
      attention_audio: audio.src,
      attention_response: ans,
      headphone_type: State.headphoneType,
      timestamp_iso: new Date().toISOString(),
    });

    card.classList.add('hidden');
    onContinue && onContinue();
  };

  card.classList.remove('hidden');
}

/* ===========================
   TRIALS: WORD ID + RT FROM AUDIO OFFSET
=========================== */
const screenTrials = document.getElementById("screen-trials");
const progressBar = document.getElementById("progressBar");
const trialTitle  = document.getElementById("trialTitle");
const player      = document.getElementById("player");
const playBtn     = document.getElementById("playBtn");
const leftBtn     = document.getElementById("leftBtn");
const rightBtn    = document.getElementById("rightBtn");
const trialStatus = document.getElementById("trialStatus");

function startTrials(){
  // optional: shuffle TRIALS once per participant
  shuffle(TRIALS);

  show("screen-trials");
  State.trialIndex = 0;
  loadTrial();
}

function setChoiceEnabled(enabled){
  leftBtn.disabled = !enabled;
  rightBtn.disabled = !enabled;
}

function updateProgress(){
  const total = TRIALS.length;
  const done = State.trialIndex;
  progressBar.style.width = `${Math.round((done/total)*100)}%`;
  trialTitle.textContent = `Trial ${Math.min(done+1,total)} of ${total}`;
}

function loadTrial(){
  const t = currentTrial();
  if(!t){ finishStudy(); return; }

  updateProgress();
  State.audioOffsetTs = null;
  State.awaitingChoice = false;

  player.src = resolveAudioUrl(t);
  player.currentTime = 0;

  // Buttons show image choices (no text labels on buttons)
  leftBtn.textContent  = "";
  rightBtn.textContent = "";

  // Load and display images
  const leftImageContainer = document.getElementById('leftImageContainer');
  const rightImageContainer = document.getElementById('rightImageContainer');
  
  leftImageContainer.innerHTML = '';
  rightImageContainer.innerHTML = '';
  
  if(t.left_image){
    const leftImg = document.createElement('img');
    leftImg.src = resolveImageUrl(t.left_image);
    leftImg.alt = "Choice image (left)";
    leftImg.style.cursor = 'pointer';
    leftImg.onclick = () => recordChoice('left');
    leftImageContainer.appendChild(leftImg);
  }
  
  if(t.right_image){
    const rightImg = document.createElement('img');
    rightImg.src = resolveImageUrl(t.right_image);
    rightImg.alt = "Choice image (right)";
    rightImg.style.cursor = 'pointer';
    rightImg.onclick = () => recordChoice('right');
    rightImageContainer.appendChild(rightImg);
  }

  setChoiceEnabled(false);
  playBtn.disabled = false;
  playBtn.textContent = "Play Audio";
  trialStatus.textContent = "Click Play to listen.";
}

playBtn.onclick = async () => {
  playBtn.disabled = true;
  playBtn.textContent = "Playing...";
  trialStatus.textContent = "Listening…";

  State.audioOffsetTs = null;
  State.awaitingChoice = false;
  setChoiceEnabled(false);

  try {
    await player.play();
  } catch (e) {
    console.error(e);
    alert("Unable to start audio playback. Please check your browser permissions.");
    playBtn.disabled = false;
    playBtn.textContent = "Play Audio";
    trialStatus.textContent = "Click Play to listen.";
  }
};

player.onended = () => {
  State.audioOffsetTs = nowMs();      // RT starts HERE (audio offset)
  State.awaitingChoice = true;
  setChoiceEnabled(true);
  trialStatus.textContent = "Choose the word you heard (F = left, J = right).";
};

function recordChoice(choiceSide){
  if(!State.awaitingChoice) return;

  const t = currentTrial();
  const clickTs = nowMs();
  const rt_ms = Math.round(clickTs - (State.audioOffsetTs ?? clickTs));

  const choice_image = (choiceSide === "left") ? t.left_image : t.right_image;
  const is_target = (choiceSide === t.target_side);

  const row = {
    participant_id: State.participantId,
    prolific_id: State.participantId,
    block: "Trials",
    trial_index: State.trialIndex + 1,
    trial_id: t.trial_id ?? "",
    audio_file: t.audio_file ?? "",
    audio_url: player.src,
    target_image: t.target_image ?? "",
    distractor_image: t.distractor_image ?? "",
    target_side: t.target_side ?? "",
    left_image: t.left_image ?? "",
    right_image: t.right_image ?? "",
    choice: choiceSide,
    choice_image: choice_image ?? "",
    is_correct: is_target ? "yes" : "no",
    reaction_time_ms: rt_ms,
    headphone_type: State.headphoneType,
    timestamp_iso: new Date().toISOString(),
  };
  
  // Add any custom CSV columns
  for(const [key, value] of Object.entries(t)){
    if(!row.hasOwnProperty(key)){
      row[key] = value ?? "";
    }
  }

  // Keep a local copy too (optional)
  State.rowsLocal.push(row);

  // Send to Google Sheet immediately (recommended)
  sendToGoogleSheet(row);

  // Lock choices
  State.awaitingChoice = false;
  setChoiceEnabled(false);

  const targetIndicator = is_target ? "✓ correct" : "✗ incorrect";
  trialStatus.textContent = `Recorded: ${targetIndicator} (RT ${rt_ms} ms).`;

  // Attention check every N trials (optional)
  const nextIndex = State.trialIndex + 1;
  const needsCheck = (CONFIG.attentionEveryNTrials > 0) && (nextIndex % CONFIG.attentionEveryNTrials === 0) && (nextIndex < TRIALS.length);

  State.trialIndex += 1;

  if(needsCheck){
    hide("screen-trials");
    showAudioAttentionCheck(() => {
      show("screen-trials");
      loadTrial();
    });
  } else {
    setTimeout(loadTrial, 250);
  }
}

leftBtn.onclick  = () => recordChoice("left");
rightBtn.onclick = () => recordChoice("right");

// Keyboard shortcuts (F/J for choices, Spacebar for play)
document.addEventListener("keydown", (e) => {
  // Spacebar to play audio
  if(e.code === "Space" && !screenTrials.classList.contains("hidden")){
    e.preventDefault();
    if(!playBtn.disabled){
      playBtn.click();
    }
    return;
  }
  
  // F/J for choices
  if(screenTrials.classList.contains("hidden")) return;
  if(!State.awaitingChoice) return;
  const k = e.key.toLowerCase();
  if(k === "f") recordChoice("left");
  if(k === "j") recordChoice("right");
});

/* ===========================
   FEEDBACK + FINAL SUBMISSION
=========================== */
document.getElementById('feedbackNextBtn').onclick = () => {
  const feedback = document.getElementById('feedbackText').value || "";

  // Send a final "end" row that includes feedback + all attention checks bundled
  const out = {
    participant_id: State.participantId,
    prolific_id: State.participantId,
    block: "Final",
    headphone_type: State.headphoneType || "",
    final_feedback: feedback || "",
    completion_code: CONFIG.completionCode,
    timestamp_iso: new Date().toISOString(),
  };
  for(let i=1;i<=CONFIG.nAttentionFiles;i++){
    out[`attention_check_${i}`] = State.attnAnswers[i-1] || "";
  }
  sendToGoogleSheet(out);

  hide("screen-feedback");
  show("screen-finish");
};

function finishStudy(){
  hide("screen-trials");
  show("screen-feedback");
}

/* ===========================
   FINISH SCREEN LINKS
=========================== */
document.getElementById("completionCode").textContent = CONFIG.completionCode;
document.getElementById("prolificReturnLink").href = CONFIG.prolificReturnUrl;
</script>

</body>
</html>
