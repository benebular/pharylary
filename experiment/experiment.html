<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Word Identification Study</title>
<style>
  body { font-family: sans-serif; background:#f5f5f5; margin:0; padding:20px; }
  .card { background:white; border-radius:8px; padding:20px; max-width:900px; margin:0 auto; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
  h1 { font-size:24px; margin-top:0; }
  .btn { padding:10px 16px; border:none; border-radius:6px; cursor:pointer; margin-right:8px; }
  .btn-primary { background:#007acc; color:white; }
  .btn-primary:disabled { background:#a0aec0; color:#e2e8f0; cursor:not-allowed; }
  .btn-secondary { background:#ccc; color:black; }
  
  /* Play button styling for trials */
  #playBtn { display:block; margin:0 auto 20px; padding:14px 32px; font-size:18px; font-weight:600; }
  .hidden { display:none; }
  .progress { height:8px; background:#eee; border-radius:4px; margin:10px 0; overflow:hidden; }
  .progress > div { height:100%; background:#007acc; width:0; transition:width .2s ease; }
  textarea { width:100%; height:100px; margin-top:8px; padding:6px; border-radius:4px; border:1px solid #ccc; font-family:sans-serif; }
  .question-block { margin:20px 0; padding:12px; background:#f9f9f9; border-radius:6px; border:1px solid #ddd; }
  .question-block p { margin:0 0 8px 0; font-weight:bold; }
  input[type="text"] { width:100%; padding:8px; font-size:14px; border:1px solid #ccc; border-radius:6px; }

  /* Two-choice layout */
  .choices { display:flex; gap:14px; margin-top:14px; }
  .choice-btn {
    flex:1;
    padding:18px 14px;
    font-size:22px;
    font-weight:700;
    border-radius:10px;
    border:1px solid #ddd;
    background:#fafafa;
    cursor:pointer;
  }
  .choice-btn:disabled { opacity:0.6; cursor:not-allowed; }
  .choice-btn { display:none; }
  .image-container img { cursor:pointer; transition:transform 0.1s, box-shadow 0.1s; }
  .image-container img:hover { transform:scale(1.05); box-shadow:0 4px 12px rgba(0,0,0,0.2); }
  .image-container img:active { transform:scale(0.98); }
  .meta { margin-top:20px; color:#555; font-size:13px; text-align:center; }
  #trialStatus { font-size:32px; font-weight:600; color:#333; margin-top:24px; }
  .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; border:1px solid #ddd; background:#f7f7f7; padding:2px 6px; border-radius:6px; }

  /* Image pair display */
  .image-pair { display:flex; gap:20px; margin:20px 0; justify-content:center; align-items:flex-start; }
  .image-container { text-align:center; }
  .image-container img { max-width:200px; max-height:200px; border-radius:8px; border:2px solid #ddd; }
  .image-label { margin-top:8px; font-weight:bold; color:#333; }

  /* Survey question styles */
  .survey-question { margin:24px 0; padding:16px; background:#f9f9f9; border-radius:6px; border-left:4px solid #007acc; }
  .survey-question-text { font-weight:600; margin-bottom:12px; font-size:15px; }
  
  /* Yes/No buttons */
  .yes-no-group { display:flex; gap:12px; }
  .yes-no-btn { flex:1; padding:10px 16px; border:2px solid #ddd; border-radius:6px; background:white; cursor:pointer; font-weight:600; transition:all 0.2s; }
  .yes-no-btn:hover { border-color:#007acc; background:#f0f7ff; }
  .yes-no-btn.selected { background:#007acc; color:white; border-color:#007acc; }
  
  /* Likert scale */
  .likert-group { display:flex; flex-direction:column; gap:8px; }
  .likert-scale { display:flex; gap:8px; margin-bottom:8px; }
  .likert-btn { flex:1; padding:10px 8px; border:2px solid #ddd; border-radius:6px; background:white; cursor:pointer; font-size:13px; transition:all 0.2s; }
  .likert-btn:hover { border-color:#007acc; background:#f0f7ff; }
  .likert-btn.selected { background:#007acc; color:white; border-color:#007acc; }
  .likert-labels { display:flex; justify-content:space-between; font-size:12px; color:#666; margin-top:4px; }
  .likert-labels span { flex:1; text-align:center; }
  
  /* Text input for demographics */
  .text-input-field { display:flex; flex-direction:column; gap:6px; }
  .text-input-field input { padding:10px 12px; border:2px solid #ddd; border-radius:6px; font-size:14px; font-family:inherit; }
  .text-input-field input:focus { outline:none; border-color:#007acc; box-shadow:0 0 0 3px rgba(0, 122, 204, 0.1); }
  
  /* Percentage slider */
  .percentage-slider-group { display:flex; flex-direction:column; gap:8px; }
  .percentage-slider-input { display:flex; align-items:center; gap:12px; }
  .percentage-slider-input input[type="range"] { flex:1; }
  .percentage-slider-input .value-display { min-width:40px; text-align:right; font-weight:600; color:#007acc; }
  .percentage-total-display { font-weight:600; font-size:14px; padding:8px 12px; border-radius:6px; margin-top:12px; text-align:center; }
  .percentage-total-display.valid { background:#e6f7e6; color:#2d662d; }
  .percentage-total-display.invalid { background:#ffe6e6; color:#8b0000; }
  
  /* Stacked Likert (two questions) */
  .stacked-likert { display:flex; flex-direction:column; gap:20px; }
  .stacked-likert-item { display:flex; flex-direction:column; gap:8px; }
  .stacked-likert-item-title { font-weight:600; font-size:13px; margin-bottom:4px; }
</style>
</head>
<body>

<!-- Consent -->
<div class="card" id="screen-consent">
  <h1>Intro and Consent</h1>
  <p>Thank you for participating! You will listen to short audio clips and choose which word you heard.</p>
  <p><strong>Important:</strong> Please wear <strong>headphones</strong> for the entire experiment.</p>
  <p>
    Before starting, please read the
    <!-- Repo structure: /pharylary/experiment/ -> ../consent/ -->
    <a href="../consent/approved_consent_prolific.pdf" target="_blank" rel="noopener noreferrer">
      Informed Consent Form
    </a>
    then check the box below once done.
  </p>

  <label><input type="checkbox" id="consentCheck"> I consent to participate</label>
  <br><br>

  <label for="prolificId"><strong>Please enter your Prolific ID:</strong></label><br>
  <input type="text" id="prolificId" placeholder="e.g., 60a1b2c3d4e5f6g7h8i9" style="width:100%; padding:8px; font-size:14px; margin-top:6px;">
  <br><br>

  <button class="btn btn-primary" id="consentBtn" disabled>Continue</button>
</div>

<!-- Headphone Info -->
<div class="card hidden" id="screen-headphones">
  <h1>Headphone Information</h1>
  <p><strong>Before continuing:</strong> Please ensure you are wearing headphones.</p>
  <p>For our records, please tell us what type of headphones you are using (e.g., AirPods, wired earbuds, over-ear headphones).</p>

  <div>
    <label><strong>Please type the name or description of your headphones below:</strong></label>
    <input type="text" id="headphoneInput" placeholder="e.g., Apple AirPods Pro, Wired Sony Over-Ear">
  </div>

  <div style="margin-top:12px;">
    <label><input type="checkbox" id="confirmHeadphones"> I confirm that I am wearing headphones</label>
  </div>
  <br>
  <button class="btn btn-primary" id="headphoneNextBtn" disabled>Continue</button>
</div>

<!-- Volume Check -->
<div class="card hidden" id="screen-volume">
  <h1>Audio Volume Check</h1>
  <p>Set your device volume to a <strong>comfortable</strong> level.</p>
  <p>Press play to hear a short test sound. You may replay as many times as you wish.</p>

  <button class="btn btn-primary" id="playVolumeCheckBtn">Play Test Audio</button>
  <audio id="volumeCheckAudio" preload="auto"></audio>

  <p style="margin-top:16px; color:#555; font-size:14px;">
    When you can clearly hear the audio, click <strong>Continue</strong>.
  </p>

  <button class="btn btn-primary" id="volumeNextBtn" disabled>Continue</button>
</div>

<!-- Audio Attention Check -->
<div class="card hidden" id="screen-audiocheck">
  <h1>Audio Check</h1>
  <button class="btn btn-primary" id="playAudioCheckBtn">Play Audio</button>
  <audio id="audioCheckPlayer"></audio>

  <div class="question-block">
    <p>Play the audio and type the English word you heard:</p>
    <input type="text" id="audioCheckResponse" style="width:300px; padding:6px;">
  </div>

  <button class="btn btn-primary" id="audioCheckNextBtn" disabled>Continue</button>
</div>

<!-- Instructions -->
<div class="card hidden" id="screen-instructions">
  <h1>Instructions</h1>
  <p>Welcome to the experiment! In this task you will be identifying words. First, you will play an audio file and listen to a word in Arabic, and then you will choose which word you just heard from the two words written in Arabic presented on the screen. Do your best and respond as quickly as you can once the audio file has stopped playing. Following the task, there will be a survey about the words and questions about your background.</p>
  <br>
  <button class="btn btn-primary" id="instructionsNextBtn">Continue</button>
</div>

<!-- Trials -->
<div class="card hidden" id="screen-trials">
  <div class="progress"><div id="progressBar"></div></div>
  <h1 id="trialTitle">Trial</h1>
  <p>
    Press <strong>spacebar</strong> to play the audio. After it ends, click an image or press <strong>F</strong> (left) / <strong>J</strong> (right) to choose the correct word.
  </p>

  <button class="btn btn-primary" id="playBtn">Play Audio</button>
  <audio id="player" preload="auto"></audio>

  <div class="image-pair" id="imagePair">
    <div class="image-container" id="leftImageContainer"></div>
    <div class="image-container" id="rightImageContainer"></div>
  </div>

  <div class="choices" style="margin-top:14px;">
    <button class="choice-btn" id="leftBtn" disabled></button>
    <button class="choice-btn" id="rightBtn" disabled></button>
  </div>

  <div class="meta" id="trialStatus">Waiting to start…</div>
</div>

<!-- Survey -->
<!-- Survey Splash Page -->
<div class="card hidden" id="screen-survey-splash">
  <h1>About the Survey</h1>
  
  <div style="background:#f9f9f9; padding:16px; border-radius:6px; margin-bottom:24px; font-size:14px; line-height:1.6;">
    <p><strong>Modern Standard Arabic, الفصحى</strong>, is often used to describe both an accent and written form of the Arabic language that is spoken and understood by speakers from different Arabic-speaking communities. It is often a second language of people who speak a dialect of Arabic as their first language. You can find Modern Standard Arabic in formal writing, news casts, journals, articles, religious texts, public or government documents and signs, or in classrooms.</p>
    
    <p><strong>Arabic dialect, العامية</strong>, is often used to describe both an accent and written form of Arabic that is specific to certain communities of people. It is usually spoken as a first language across these communities. In many cases, there is a lot less that is shared between dialects of Arabic in terms of accent and written form. Examples of dialectal Arabic include Palestinian, Egyptian, Gulf, Najdi, Sudanese, Tunisian, and Yemeni Arabic.</p>
    
    <p style="margin-top:16px;">The following questions will ask you about a word's status in Modern Standard Arabic and Arabic dialect.</p>
  </div>

  <button class="btn btn-primary" id="surveySplashNextBtn" style="margin-top:20px;">Continue to Survey</button>
</div>

<!-- Survey Splash Page -->
<div class="card hidden" id="screen-survey-splash">
  <h1>About the Survey</h1>
  
  <div style="background:#f9f9f9; padding:16px; border-radius:6px; margin-bottom:24px; font-size:14px; line-height:1.6;">
    <p><strong>Modern Standard Arabic, الفصحى</strong>, is often used to describe both an accent and written form of the Arabic language that is spoken and understood by speakers from different Arabic-speaking communities. It is often a second language of people who speak a dialect of Arabic as their first language. You can find Modern Standard Arabic in formal writing, news casts, journals, articles, religious texts, public or government documents and signs, or in classrooms.</p>
    
    <p><strong>Arabic dialect, العامية</strong>, is often used to describe both an accent and written form of Arabic that is specific to certain communities of people. It is usually spoken as a first language across these communities. In many cases, there is a lot less that is shared between dialects of Arabic in terms of accent and written form. Examples of dialectal Arabic include Palestinian, Egyptian, Gulf, Najdi, Sudanese, Tunisian, and Yemeni Arabic.</p>
    
    <p style="margin-top:16px;">The following questions will ask you about a word's status in Modern Standard Arabic and Arabic dialect.</p>
  </div>

  <button class="btn btn-primary" id="surveySplashNextBtn" style="margin-top:20px;">Continue to Survey</button>
</div>

<div class="card hidden" id="screen-survey">
  <div class="progress"><div id="surveyProgressBar"></div></div>
  <h1 id="surveyTitle">Survey</h1>
  
  <p style="margin:16px 0; font-size:15px; line-height:1.5;">Please listen to the audio for the presented word and then answer the questions below. You can click the Play Audio button or press the spacebar to play the audio. You may listen to the audio as many times as you need. For question 2, if you did not understand the word, mark "Do Not Understand."</p>
  
  <div class="image-container" id="surveyImageContainer" style="margin:20px 0; text-align:center;"></div>
  
  <div style="margin:20px 0; text-align:center;">
    <button class="btn btn-primary" id="surveySoundBtn">Play Audio</button>
    <audio id="surveyPlayer" preload="auto"></audio>
  </div>

  <div id="surveyQuestionsContainer"></div>

  <button class="btn btn-primary" id="surveyNextBtn" style="margin-top:20px;">Next</button>
</div>

<!-- Demographics -->
<div class="card hidden" id="screen-demographics">
  <h1>Background Information</h1>
  
  <div style="background:#f9f9f9; padding:16px; border-radius:6px; margin-bottom:24px; font-size:14px; line-height:1.6;">
    <p><strong>Modern Standard Arabic, الفصحى</strong>, is often used to describe both an accent and written form of the Arabic language that is spoken and understood by speakers from different Arabic-speaking communities. It is often a second language of people who speak a dialect of Arabic as their first language. You can find Modern Standard Arabic in formal writing, news casts, journals, articles, religious texts, public or government documents and signs, or in classrooms.</p>
    
    <p><strong>Arabic dialect, العامية</strong>, is often used to describe both an accent and written form of Arabic that is specific to certain communities of people. It is usually spoken as a first language across these communities. In many cases, there is a lot less that is shared between dialects of Arabic in terms of accent and written form. Examples of dialectal Arabic include Palestinian, Egyptian, Gulf, Najdi, Sudanese, Tunisian, and Yemeni Arabic.</p>
    
    <p>The following questions will ask you about your knowledge and usage of these two broad types of Arabic, and any other languages you know.</p>
  </div>

  <div id="demographicsQuestionsContainer"></div>

  <button class="btn btn-primary" id="demographicsNextBtn" style="margin-top:20px;">Continue</button>
</div>

<!-- Demographics - Language Use -->
<div class="card hidden" id="screen-demographics-language">
  <h1>Language Use and Background</h1>

  <div id="demographicsLanguageQuestionsContainer"></div>

  <button class="btn btn-primary" id="demographicsLanguageNextBtn" style="margin-top:20px;">Continue</button>
</div>

<!-- Feedback -->
<div class="card hidden" id="screen-feedback">
  <h1>Final Feedback (optional)</h1>
  <textarea id="feedbackText" placeholder="Any comments about the task?"></textarea>
  <button class="btn btn-primary" id="feedbackNextBtn">Submit</button>
</div>

<!-- Finish -->
<div class="card hidden" id="screen-finish">
  <h1>All Done!</h1>
  <p>Thank you for participating in this study.</p>
  <p><strong>Your participation code:</strong> <code id="completionCode">CJUVEL1D</code></p>
  <p>
    Please click the link below to complete your submission on Prolific:
  </p>
  <p>
    <a id="prolificReturnLink" href="https://app.prolific.com/submissions/complete?cc=CJUVEL1D" target="_blank" style="font-size:16px; color:#007acc; text-decoration:underline;">
      ➤ Click here to return to Prolific and submit your study
    </a>
  </p>
</div>

<script>
/* ===========================
   CONFIG
=========================== */

/** Google Apps Script endpoint (same as your template) */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxblhxJ34A7WfooWQBdKIdzPLMpyPfbOWnHmNdGsbWXa72ZxqYIR-2gaMa8jV7jnRcebw/exec";

/** Repo structure:
 *  - This file is /pharylary/experiment/index.html
 *  - Audio is /pharylary/data/audio/
 *  - Images are /pharylary/data/images/
 *  - Trials CSV is /pharylary/data/trials.csv
 *  - Attention check audio is /pharylary/experiment/audio_check/
 *  - Volume check audio can also live in /pharylary/experiment/audio_check/
 */
const CONFIG = {
  audioBase: "../data/audio",          // from /experiment/ to /data/audio/
  audioSuffix: ".wav",
  imageBase: "../data/images",         // from /experiment/ to /data/images/
  // Use relative path for local testing with Live Server
  // Use GitHub raw URL when deployed to GitHub Pages
  // trialsUrl: "../data/trials.csv",     // Change to GitHub raw URL when deploying
  trialsUrl: "https://raw.githubusercontent.com/benebular/pharylary/main/data/trials.csv",
  attnBase: "./audio_check",           // inside /experiment/audio_check/
  attnFileNames: [
    "alice_b.wav", "bean_b.wav", "beaten_t_b.wav", "bun_b.wav",
    "curly_b.wav", "dane_b.wav", "den_b.wav", "dent_t_b.wav",
    "faint_t_b.wav", "feign_b.wav", "gone_b.wav", "greatness_gs_b.wav",
    "jaunt_t_b.wav", "keen_b.wav", "motley_t_b.wav", "ron_b.wav",
    "sane_b.wav", "seller_b.wav", "tin_b.wav", "tint_t_b.wav", "whinny_b.wav"
  ],
  volumeCheckFile: "./audio_check/gone_b.wav", // put this file in experiment/audio_check/
  attentionEveryNTrials: 28,          // ~10% of trials (282 trials / 28 ≈ 28 checks)
  completionCode: "CJY9T9NA",
  prolificReturnUrl: "https://app.prolific.com/submissions/complete?cc=CJY9T9NA",
};

/** Trials: Loaded from CSV
 *  CSV should have columns: TargetWordAudioFile, TargetWordImageFile, DistractorWordImageFile
 *  Each row becomes one trial.
 *  Target and distractor images are randomly assigned to left/right for each trial.
 */
let TRIALS = [];

/* ===========================
   STATE
=========================== */
const State = {
  participantId: null,      // Prolific ID
  headphoneType: "",
  trialIndex: 0,
  audioOffsetTs: null,      // performance.now() at audio offset
  awaitingChoice: false,
  attnQueue: [],
  attnAnswers: [],
  rowsLocal: [],            // optional local copy
};

/* ===========================
   HELPERS
=========================== */
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function nowMs(){ return performance.now(); }
function randomBoolean(){ return Math.random() > 0.5; }

function sendToGoogleSheet(obj){
  const fd = new FormData();
  for (const k in obj) fd.append(k, obj[k] ?? "");
  fetch(SCRIPT_URL, { method:"POST", body:fd }).catch(err=>console.error("Sheet POST error:", err));
}

function show(id){ document.getElementById(id).classList.remove("hidden"); }
function hide(id){ document.getElementById(id).classList.add("hidden"); }

function currentTrial(){ return TRIALS[State.trialIndex]; }
function resolveAudioUrl(trial){
  // allow either audio_file or audio_url; prefer audio_url if provided
  if(trial.audio_file) return `${CONFIG.audioBase}/${trial.audio_file}`;
  return trial.audio_url || "";
}
function resolveImageUrl(filename){
  // resolve image filename to full path
  return `${CONFIG.imageBase}/${filename}`;
}

/* ===========================
   CSV PARSING & TRIAL SETUP
=========================== */
function parseCSV(text){
  const lines = text.trim().split('\n');
  if(lines.length < 2) return [];
  
  // Parse header row
  const headerLine = lines[0];
  const headers = headerLine.split(',').map(h => h.trim());
  
  // Find column indices for required fields
  const targetAudioIdx = headers.indexOf('TargetWordAudioFile');
  const targetImageIdx = headers.indexOf('TargetWordImageFile');
  const distractorImageIdx = headers.indexOf('DistractorWordImageFile');
  
  if(targetAudioIdx === -1 || targetImageIdx === -1 || distractorImageIdx === -1){
    console.error('CSV missing required columns');
    return [];
  }
  
  // Parse data rows
  const trials = [];
  for(let i = 1; i < lines.length; i++){
    const line = lines[i].trim();
    if(!line) continue; // skip empty lines
    
    const cells = line.split(',').map(c => c.trim());
    const audioFile = cells[targetAudioIdx] || '';
    const targetImage = cells[targetImageIdx] || '';
    const distractorImage = cells[distractorImageIdx] || '';
    
    if(!audioFile || !targetImage || !distractorImage) continue;
    
    // Randomly assign target/distractor to left/right
    const targetLeft = randomBoolean();
    
    // Capture all other columns as custom data
    const customData = {};
    for(let j = 0; j < headers.length; j++){
      if(j !== targetAudioIdx && j !== targetImageIdx && j !== distractorImageIdx){
        customData[headers[j]] = cells[j] || '';
      }
    }
    
    const trial = {
      trial_id: i,
      audio_file: audioFile,
      target_image: targetImage,
      distractor_image: distractorImage,
      target_side: targetLeft ? "left" : "right",
      left_image: targetLeft ? targetImage : distractorImage,
      right_image: targetLeft ? distractorImage : targetImage,
      ...customData  // Spread custom columns into trial object
    };
    
    trials.push(trial);
  }
  
  return trials;
}

async function loadTrialsFromCSV(){
  try {
    const response = await fetch(CONFIG.trialsUrl);
    if(!response.ok) throw new Error(`Failed to load CSV: ${response.statusText}`);
    
    const csvText = await response.text();
    TRIALS = parseCSV(csvText);
    
    if(TRIALS.length === 0){
      alert("No valid trials found in CSV file. Check the file format and column names.");
      return false;
    }
    
    console.log(`Loaded ${TRIALS.length} trials from CSV`);
    return true;
  } catch (err) {
    console.error('CSV load error:', err);
    alert("Failed to load trials from CSV file. Check the browser console for details.");
    return false;
  }
}

/* ===========================
   CONSENT + HEADPHONES
=========================== */
const consentCheck = document.getElementById('consentCheck');
const prolificInput = document.getElementById('prolificId');
const consentBtn = document.getElementById('consentBtn');

function updateConsentContinue(){
  consentBtn.disabled = !(consentCheck.checked && prolificInput.value.trim().length > 0);
}
consentCheck.onchange = updateConsentContinue;
prolificInput.oninput  = updateConsentContinue;

consentBtn.onclick = () => {
  const rawId = prolificInput.value || "";
  const idVal = rawId.trim();
  if(!idVal){ alert("Please enter your Prolific ID before continuing."); return; }
  State.participantId = idVal;

  // normalize for testing shortcuts (case-insensitive)
  const idNorm = idVal.toLowerCase();

  // Testing shortcuts
  if(idNorm === "bubbleboy"){
    // Skip to survey task
    loadTrialsFromCSV().then(success => {
      if(success){
        hide("screen-consent");
        startSurvey();
      }
    });
    return;
  }

  if(idNorm === "bubbleboy2"){
    // Skip to survey splash page
    loadTrialsFromCSV().then(success => {
      if(success){
        hide("screen-consent");
        showSurveySplash();
      }
    });
    return;
  }

  if(idNorm === "bubbleboy3"){
    // Skip to demographics
    loadTrialsFromCSV().then(success => {
      if(success){
        hide("screen-consent");
        showDemographics();
      }
    });
    return;
  }

  // Load trials from CSV before proceeding
  consentBtn.disabled = true;
  consentBtn.textContent = "Loading trials...";

  loadTrialsFromCSV().then(success => {
    if(success){
      hide("screen-consent");
      show("screen-headphones");
    }
    consentBtn.disabled = false;
    consentBtn.textContent = "Continue";
  });
};

const headphoneInput = document.getElementById('headphoneInput');
const confirmHeadphones = document.getElementById('confirmHeadphones');
const headphoneNextBtn = document.getElementById('headphoneNextBtn');

function updateHeadphoneContinue(){
  headphoneNextBtn.disabled = !(headphoneInput.value.trim() && confirmHeadphones.checked);
}
headphoneInput.oninput = updateHeadphoneContinue;
confirmHeadphones.onchange = updateHeadphoneContinue;

headphoneNextBtn.onclick = () => {
  State.headphoneType = headphoneInput.value.trim();
  hide("screen-headphones");
  show("screen-volume");
};

/* ===========================
   VOLUME CHECK
=========================== */
const volumeAudio = document.getElementById('volumeCheckAudio');
const playVolumeBtn = document.getElementById('playVolumeCheckBtn');
const volumeNextBtn = document.getElementById('volumeNextBtn');

volumeAudio.src = CONFIG.volumeCheckFile;

playVolumeBtn.onclick = async () => {
  try {
    await volumeAudio.play();
    volumeNextBtn.disabled = false;
    playVolumeBtn.textContent = "Playing...";
    playVolumeBtn.disabled = true;
  } catch (err) {
    alert("Unable to start audio playback. Please check browser permissions and try again.");
    playVolumeBtn.disabled = false;
    playVolumeBtn.textContent = "Play Test Audio";
  }
};
volumeAudio.onended = () => {
  playVolumeBtn.textContent = "Replay Audio";
  playVolumeBtn.disabled = false;
};
volumeNextBtn.onclick = () => {
  volumeAudio.pause();
  hide("screen-volume");
  prepareAttentionQueue();
  showAudioAttentionCheck(() => showInstructions());
};

/* ===========================
   ATTENTION CHECKS
=========================== */
function prepareAttentionQueue(){
  const urls = CONFIG.attnFileNames.map(filename => `${CONFIG.attnBase}/${filename}`);
  State.attnQueue = shuffle(urls);
}
function nextAttentionAudio(){
  if(State.attnQueue.length===0) prepareAttentionQueue();
  return State.attnQueue.shift();
}

function showAudioAttentionCheck(onContinue){
  const card = document.getElementById('screen-audiocheck');
  const playBtn = document.getElementById('playAudioCheckBtn');
  const audio   = document.getElementById('audioCheckPlayer');
  const input   = document.getElementById('audioCheckResponse');
  const nextBtn = document.getElementById('audioCheckNextBtn');

  input.value = "";
  nextBtn.disabled = true;

  playBtn.disabled = false;
  playBtn.textContent = "Play Audio";

  audio.src = nextAttentionAudio();
  audio.currentTime = 0;

  playBtn.onclick = async () => {
    try {
      playBtn.disabled = true;
      playBtn.textContent = "Playing...";
      await audio.play();
    } catch {
      alert("Please check your browser audio permissions.");
      playBtn.disabled = false;
      playBtn.textContent = "Play Audio";
    }
  };

  audio.onended = () => {
    playBtn.textContent = "Audio finished";
    playBtn.disabled = true;
  };

  input.oninput = () => { nextBtn.disabled = !input.value.trim(); };

  nextBtn.onclick = () => {
    const ans = input.value.trim();
    if(!ans){ alert("Please type your answer before continuing."); return; }
    State.attnAnswers.push(ans);

    // optionally send attention check row immediately
    sendToGoogleSheet({
      participant_id: State.participantId,
      prolific_id: State.participantId,
      block: "AttentionCheck",
      attention_index: State.attnAnswers.length,
      attention_audio: audio.src,
      attention_response: ans,
      headphone_type: State.headphoneType,
      timestamp_iso: new Date().toISOString(),
    });

    card.classList.add('hidden');
    onContinue && onContinue();
  };

  card.classList.remove('hidden');
}

/* ===========================
   INSTRUCTIONS SCREEN
=========================== */
function showInstructions(){
  const instructionsNextBtn = document.getElementById('instructionsNextBtn');
  
  instructionsNextBtn.onclick = () => {
    hide("screen-instructions");
    startTrials();
  };
  
  show("screen-instructions");
}

/* ===========================
   TRIALS: WORD ID + RT FROM AUDIO OFFSET
=========================== */
const screenTrials = document.getElementById("screen-trials");
const progressBar = document.getElementById("progressBar");
const trialTitle  = document.getElementById("trialTitle");
const player      = document.getElementById("player");
const playBtn     = document.getElementById("playBtn");
const leftBtn     = document.getElementById("leftBtn");
const rightBtn    = document.getElementById("rightBtn");
const trialStatus = document.getElementById("trialStatus");

function startTrials(){
  // optional: shuffle TRIALS once per participant
  shuffle(TRIALS);

  show("screen-trials");
  State.trialIndex = 0;
  loadTrial();
}

function setChoiceEnabled(enabled){
  leftBtn.disabled = !enabled;
  rightBtn.disabled = !enabled;
}

function updateProgress(){
  const total = TRIALS.length;
  const done = State.trialIndex;
  progressBar.style.width = `${Math.round((done/total)*100)}%`;
  trialTitle.textContent = `Trial ${Math.min(done+1,total)} of ${total}`;
}

function loadTrial(){
  const t = currentTrial();
  if(!t){ finishStudy(); return; }

  updateProgress();
  State.audioOffsetTs = null;
  State.awaitingChoice = false;

  player.src = resolveAudioUrl(t);
  player.currentTime = 0;

  // Buttons show image choices (no text labels on buttons)
  leftBtn.textContent  = "";
  rightBtn.textContent = "";

  // Load and display images
  const leftImageContainer = document.getElementById('leftImageContainer');
  const rightImageContainer = document.getElementById('rightImageContainer');
  
  leftImageContainer.innerHTML = '';
  rightImageContainer.innerHTML = '';
  
  if(t.left_image){
    const leftImg = document.createElement('img');
    leftImg.src = resolveImageUrl(t.left_image);
    leftImg.alt = "Choice image (left)";
    leftImg.style.cursor = 'pointer';
    leftImg.onclick = () => recordChoice('left');
    leftImageContainer.appendChild(leftImg);
  }
  
  if(t.right_image){
    const rightImg = document.createElement('img');
    rightImg.src = resolveImageUrl(t.right_image);
    rightImg.alt = "Choice image (right)";
    rightImg.style.cursor = 'pointer';
    rightImg.onclick = () => recordChoice('right');
    rightImageContainer.appendChild(rightImg);
  }

  setChoiceEnabled(false);
  playBtn.disabled = false;
  playBtn.textContent = "Play Audio";
  trialStatus.textContent = "Click Play to listen.";
}

playBtn.onclick = async () => {
  playBtn.disabled = true;
  playBtn.textContent = "Playing...";
  trialStatus.textContent = "Listening…";

  State.audioOffsetTs = null;
  State.awaitingChoice = false;
  setChoiceEnabled(false);

  try {
    await player.play();
  } catch (e) {
    console.error(e);
    alert("Unable to start audio playback. Please check your browser permissions.");
    playBtn.disabled = false;
    playBtn.textContent = "Play Audio";
    trialStatus.textContent = "Click Play to listen.";
  }
};

player.onended = () => {
  State.audioOffsetTs = nowMs();      // RT starts HERE (audio offset)
  State.awaitingChoice = true;
  setChoiceEnabled(true);
  trialStatus.textContent = "Choose the word you heard (F = left, J = right).";
};

function recordChoice(choiceSide){
  if(!State.awaitingChoice) return;

  const t = currentTrial();
  const clickTs = nowMs();
  const rt_ms = Math.round(clickTs - (State.audioOffsetTs ?? clickTs));

  const choice_image = (choiceSide === "left") ? t.left_image : t.right_image;
  const is_target = (choiceSide === t.target_side);

  const row = {
    participant_id: State.participantId,
    prolific_id: State.participantId,
    block: "Trials",
    trial_index: State.trialIndex + 1,
    trial_id: t.trial_id ?? "",
    audio_file: t.audio_file ?? "",
    audio_url: player.src,
    target_image: t.target_image ?? "",
    distractor_image: t.distractor_image ?? "",
    target_side: t.target_side ?? "",
    left_image: t.left_image ?? "",
    right_image: t.right_image ?? "",
    choice: choiceSide,
    choice_image: choice_image ?? "",
    is_correct: is_target ? "yes" : "no",
    reaction_time_ms: rt_ms,
    headphone_type: State.headphoneType,
    timestamp_iso: new Date().toISOString(),
  };
  
  // Add any custom CSV columns
  for(const [key, value] of Object.entries(t)){
    if(!row.hasOwnProperty(key)){
      row[key] = value ?? "";
    }
  }

  // Keep a local copy too (optional)
  State.rowsLocal.push(row);

  // Send to Google Sheet immediately (recommended)
  sendToGoogleSheet(row);

  // Lock choices
  State.awaitingChoice = false;
  setChoiceEnabled(false);

  const targetIndicator = is_target ? "✓ Correct" : "✗ Incorrect";
  trialStatus.textContent = targetIndicator;

  // Attention check every N trials (optional)
  const nextIndex = State.trialIndex + 1;
  const needsCheck = (CONFIG.attentionEveryNTrials > 0) && (nextIndex % CONFIG.attentionEveryNTrials === 0) && (nextIndex < TRIALS.length);

  State.trialIndex += 1;

  if(needsCheck){
    setTimeout(() => {
      hide("screen-trials");
      showAudioAttentionCheck(() => {
        show("screen-trials");
        loadTrial();
      });
    }, 1000);
  } else {
    setTimeout(loadTrial, 1000);
  }
}

leftBtn.onclick  = () => recordChoice("left");
rightBtn.onclick = () => recordChoice("right");

// Keyboard shortcuts (F/J for choices, Spacebar for play)
document.addEventListener("keydown", (e) => {
  // Spacebar to play audio
  if(e.code === "Space" && !screenTrials.classList.contains("hidden")){
    e.preventDefault();
    if(!playBtn.disabled){
      playBtn.click();
    }
    return;
  }
  
  // F/J for choices
  if(screenTrials.classList.contains("hidden")) return;
  if(!State.awaitingChoice) return;
  const k = e.key.toLowerCase();
  if(k === "f") recordChoice("left");
  if(k === "j") recordChoice("right");
});

/* ===========================
   FEEDBACK + FINAL SUBMISSION
=========================== */
document.getElementById('feedbackNextBtn').onclick = () => {
  const feedback = document.getElementById('feedbackText').value || "";

  // Send a final "end" row that includes feedback + all attention checks bundled
  const out = {
    participant_id: State.participantId,
    prolific_id: State.participantId,
    block: "Final",
    headphone_type: State.headphoneType || "",
    final_feedback: feedback || "",
    completion_code: CONFIG.completionCode,
    timestamp_iso: new Date().toISOString(),
  };
  for(let i=0;i<State.attnAnswers.length;i++){
    out[`attention_check_${i+1}`] = State.attnAnswers[i] || "";
  }
  sendToGoogleSheet(out);

  hide("screen-feedback");
  show("screen-finish");
};

function finishStudy(){
  hide("screen-trials");
  showSurveySplash();
}

function showSurveySplash(){
  const splashBtn = document.getElementById('surveySplashNextBtn');
  splashBtn.onclick = () => {
    hide('screen-survey-splash');
    startSurvey();
  };
  show('screen-survey-splash');
}

/* ===========================
   SURVEY TASK
=========================== */
let surveyIndex = 0;

function startSurvey(){
  // Shuffle the trials using Fisher-Yates algorithm
  for(let i = TRIALS.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [TRIALS[i], TRIALS[j]] = [TRIALS[j], TRIALS[i]];
  }
  
  surveyIndex = 0;
  loadSurveyQuestion();
}

function loadSurveyQuestion(){
  const t = TRIALS[surveyIndex];
  if(!t){ 
    hide("screen-survey");
    showDemographics();
    return; 
  }

  // Update progress
  const surveyProgressBar = document.getElementById("surveyProgressBar");
  const surveyTitle = document.getElementById("surveyTitle");
  const total = TRIALS.length;
  surveyProgressBar.style.width = `${Math.round(((surveyIndex + 1)/total)*100)}%`;
  surveyTitle.textContent = `Survey - Item ${surveyIndex + 1} of ${total}`;

  // Load audio
  const surveyPlayer = document.getElementById("surveyPlayer");
  surveyPlayer.src = resolveAudioUrl(t);
  surveyPlayer.currentTime = 0;

  // Set up audio button click handler
  const surveySoundBtn = document.getElementById("surveySoundBtn");
  surveySoundBtn.onclick = async () => {
    try {
      surveySoundBtn.disabled = true;
      surveySoundBtn.textContent = "Playing...";
      await surveyPlayer.play();
    } catch (err) {
      console.error("Audio playback error:", err);
      alert("Unable to play audio. Please check your browser permissions.");
      surveySoundBtn.disabled = false;
      surveySoundBtn.textContent = "Play Audio";
    }
  };
  surveySoundBtn.disabled = false;
  surveySoundBtn.textContent = "Play Audio";
  
  surveyPlayer.onended = () => {
    surveySoundBtn.disabled = false;
    surveySoundBtn.textContent = "Play Audio";
  };

  // Add spacebar listener for audio playback
  const playAudioOnSpacebar = async (e) => {
    if(e.code === "Space"){
      e.preventDefault();
      surveySoundBtn.click();
    }
  };
  document.addEventListener("keydown", playAudioOnSpacebar);
  
  // Store listener reference so we can remove it later
  window.currentSurveyKeyListener = playAudioOnSpacebar;

  // Load image
  const surveyImageContainer = document.getElementById("surveyImageContainer");
  surveyImageContainer.innerHTML = '';
  if(t.target_image){
    const img = document.createElement('img');
    img.src = resolveImageUrl(t.target_image);
    img.alt = "Target word image";
    img.style.maxWidth = "200px";
    img.style.maxHeight = "200px";
    img.style.borderRadius = "8px";
    img.style.border = "2px solid #ddd";
    surveyImageContainer.appendChild(img);
  }

  // Add English definition if available
  if(t.TargetDefinition){
    const defDiv = document.createElement('div');
    defDiv.style.margin = "16px 0";
    defDiv.style.fontSize = "18px";
    defDiv.style.lineHeight = "1.4";
    defDiv.innerHTML = `<strong>English definition:</strong> ${t.TargetDefinition}`;
    surveyImageContainer.appendChild(defDiv);
  }

  // Build questions container
  const questionsContainer = document.getElementById("surveyQuestionsContainer");
  questionsContainer.innerHTML = '';

  // Store responses for this item
  const responses = {};

  // Question 1: How familiar are you with this word? (Likert 1-7)
  const q1 = createQuestion(
    "How familiar are you with this word?",
    createLikertScale(responses, "recognize", "I don't recognize this word", "I hear this word all the time")
  );
  questionsContainer.appendChild(q1);

  // Question 2: How well do you understand this word? (Likert 1-7 + N/A)
  const q2 = createQuestion(
    "How well do you understand this word?",
    createLikertScaleWithNA(responses, "understand", "Not Well", "Well")
  );
  questionsContainer.appendChild(q2);

  // Question 3: Does this English meaning match? (Likert 1-7)
  const q3 = createQuestion(
    "Does the English meaning below the word match the Arabic meaning?",
    createLikertScale(responses, "meaning_match", "No Match", "Match")
  );
  questionsContainer.appendChild(q3);

  // Question 4: MSA or Dialect? (Multiple choice: MSA, Dialect, Both)
  const q4 = createQuestion(
    "Does this pronunciation sound like Modern Standard Arabic (الفصحى)or a dialect (العامية)? ",
    createMSADialectChoice(responses, "msa_dialect")
  );
  questionsContainer.appendChild(q4);

  // Question 5: Natural production? (Likert 1-7)
  const q5 = createQuestion(
    "Is this a good, normal, and natural production/pronunciation of the word?",
    createLikertScale(responses, "natural", "Not natural", "Natural")
  );
  questionsContainer.appendChild(q5);

  // Disable response controls until audio is played at least once
  const surveyNextBtn = document.getElementById("surveyNextBtn");
  function setSurveyInputsEnabled(enabled){
    const inputs = questionsContainer.querySelectorAll('button');
    inputs.forEach(b => { try{ b.disabled = !enabled; }catch(e){} });
    surveyNextBtn.disabled = !enabled;
  }
  // Start disabled
  setSurveyInputsEnabled(false);

  // Enable when audio actually starts playing
  surveyPlayer.onplay = () => { setSurveyInputsEnabled(true); };

  // Also enable after a successful click/play attempt
  const origSurveySoundOnclick = surveySoundBtn.onclick;
  surveySoundBtn.onclick = async () => {
    try {
      // call original handler which attempts to play
      await origSurveySoundOnclick();
    } catch (e) {
      // ignore
    }
    // If playback started, onplay will enable controls; otherwise enable defensively
    setTimeout(() => { setSurveyInputsEnabled(true); }, 500);
  };

  surveyNextBtn.onclick = () => {
    // Check if all questions answered
    const allAnswered = responses.recognize && responses.understand && responses.meaning_match && responses.msa_dialect && responses.natural;
    if(!allAnswered){
      alert("Please answer all questions before continuing.");
      return;
    }

    // Send responses to Google Sheet
    sendSurveyResponse(t, responses);

    // Move to next survey item
    surveyIndex += 1;
    
    // Scroll to top of page
    window.scrollTo(0, 0);
    
    loadSurveyQuestion();
  };

  show("screen-survey");
}

function createQuestion(questionText, responseElement){
  const div = document.createElement('div');
  div.className = 'survey-question';
  
  const label = document.createElement('div');
  label.className = 'survey-question-text';
  label.textContent = questionText;
  div.appendChild(label);
  
  div.appendChild(responseElement);
  return div;
}

function createYesNoButtons(responses, key){
  const div = document.createElement('div');
  div.className = 'yes-no-group';
  
  const yesBtn = document.createElement('button');
  yesBtn.className = 'yes-no-btn';
  yesBtn.textContent = 'Yes';
  yesBtn.onclick = () => {
    responses[key] = 'yes';
    yesBtn.classList.add('selected');
    noBtn.classList.remove('selected');
  };
  
  const noBtn = document.createElement('button');
  noBtn.className = 'yes-no-btn';
  noBtn.textContent = 'No';
  noBtn.onclick = () => {
    responses[key] = 'no';
    noBtn.classList.add('selected');
    yesBtn.classList.remove('selected');
  };
  
  div.appendChild(yesBtn);
  div.appendChild(noBtn);
  return div;
}

function createLikertScale(responses, key, leftLabel, rightLabel){
  const div = document.createElement('div');
  div.className = 'likert-group';
  
  const scaleDiv = document.createElement('div');
  scaleDiv.className = 'likert-scale';
  
  const buttons = [];
  for(let i = 1; i <= 7; i++){
    const btn = document.createElement('button');
    btn.className = 'likert-btn';
    btn.textContent = i;
    btn.onclick = () => {
      responses[key] = i;
      buttons.forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
    };
    buttons.push(btn);
    scaleDiv.appendChild(btn);
  }
  
  const labelsDiv = document.createElement('div');
  labelsDiv.className = 'likert-labels';
  const leftSpan = document.createElement('span');
  leftSpan.textContent = leftLabel;
  const rightSpan = document.createElement('span');
  rightSpan.textContent = rightLabel;
  labelsDiv.appendChild(leftSpan);
  labelsDiv.appendChild(rightSpan);
  
  div.appendChild(scaleDiv);
  div.appendChild(labelsDiv);
  return div;
}

function createLikertScaleWithNA(responses, key, leftLabel, rightLabel){
  const div = document.createElement('div');
  div.className = 'likert-group';
  
  const scaleDiv = document.createElement('div');
  scaleDiv.className = 'likert-scale';
  
  const buttons = [];
  for(let i = 1; i <= 7; i++){
    const btn = document.createElement('button');
    btn.className = 'likert-btn';
    btn.textContent = i;
    btn.onclick = () => {
      responses[key] = i;
      buttons.forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      naBtn.classList.remove('selected');
    };
    buttons.push(btn);
    scaleDiv.appendChild(btn);
  }
  
  const naBtn = document.createElement('button');
  naBtn.className = 'likert-btn';
  naBtn.textContent = 'Do not understand';
  naBtn.style.marginTop = '8px';
  naBtn.onclick = () => {
    responses[key] = 'NA';
    buttons.forEach(b => b.classList.remove('selected'));
    naBtn.classList.add('selected');
  };
  scaleDiv.appendChild(naBtn);
  
  const labelsDiv = document.createElement('div');
  labelsDiv.className = 'likert-labels';
  const leftSpan = document.createElement('span');
  leftSpan.textContent = leftLabel;
  const rightSpan = document.createElement('span');
  rightSpan.textContent = rightLabel;
  labelsDiv.appendChild(leftSpan);
  labelsDiv.appendChild(rightSpan);
  
  div.appendChild(scaleDiv);
  div.appendChild(labelsDiv);
  return div;
}

function createMSADialectChoice(responses, key){
  const div = document.createElement('div');
  div.className = 'yes-no-group';
  
  const dialectBtn = document.createElement('button');
  dialectBtn.className = 'yes-no-btn';
  dialectBtn.textContent = 'Dialect';
  dialectBtn.onclick = () => {
    responses[key] = 'dialect';
    dialectBtn.classList.add('selected');
    msaBtn.classList.remove('selected');
    bothBtn.classList.remove('selected');
  };
  
  const msaBtn = document.createElement('button');
  msaBtn.className = 'yes-no-btn';
  msaBtn.textContent = 'MSA';
  msaBtn.onclick = () => {
    responses[key] = 'msa';
    msaBtn.classList.add('selected');
    dialectBtn.classList.remove('selected');
    bothBtn.classList.remove('selected');
  };
  
  const bothBtn = document.createElement('button');
  bothBtn.className = 'yes-no-btn';
  bothBtn.textContent = 'Both';
  bothBtn.onclick = () => {
    responses[key] = 'both';
    bothBtn.classList.add('selected');
    dialectBtn.classList.remove('selected');
    msaBtn.classList.remove('selected');
  };
  
  div.appendChild(dialectBtn);
  div.appendChild(msaBtn);
  div.appendChild(bothBtn);
  return div;
}

function createLikertScaleWithBoth(responses, key, leftLabel, rightLabel){
  const div = document.createElement('div');
  div.className = 'likert-group';
  
  const scaleDiv = document.createElement('div');
  scaleDiv.className = 'likert-scale';
  
  const buttons = [];
  for(let i = 1; i <= 7; i++){
    const btn = document.createElement('button');
    btn.className = 'likert-btn';
    btn.textContent = i;
    btn.onclick = () => {
      responses[key] = i;
      buttons.forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      bothBtn.classList.remove('selected');
    };
    buttons.push(btn);
    scaleDiv.appendChild(btn);
  }
  
  const bothBtn = document.createElement('button');
  bothBtn.className = 'likert-btn';
  bothBtn.textContent = 'Both';
  bothBtn.style.marginTop = '8px';
  bothBtn.onclick = () => {
    responses[key] = 'both';
    buttons.forEach(b => b.classList.remove('selected'));
    bothBtn.classList.add('selected');
  };
  scaleDiv.appendChild(bothBtn);
  
  const labelsDiv = document.createElement('div');
  labelsDiv.className = 'likert-labels';
  const leftSpan = document.createElement('span');
  leftSpan.textContent = leftLabel;
  const rightSpan = document.createElement('span');
  rightSpan.textContent = rightLabel;
  labelsDiv.appendChild(leftSpan);
  labelsDiv.appendChild(rightSpan);
  
  div.appendChild(scaleDiv);
  div.appendChild(labelsDiv);
  return div;
}

function sendSurveyResponse(trial, responses){
  const row = {
    participant_id: State.participantId,
    prolific_id: State.participantId,
    block: "Survey",
    survey_index: surveyIndex + 1,
    trial_id: trial.trial_id ?? "",
    audio_file: trial.audio_file ?? "",
    target_image: trial.target_image ?? "",
    recognize: responses.recognize ?? "",
    understand: responses.understand ?? "",
    meaning_match: responses.meaning_match ?? "",
    msa_dialect: responses.msa_dialect ?? "",
    natural: responses.natural ?? "",
    headphone_type: State.headphoneType,
    timestamp_iso: new Date().toISOString(),
  };
  
  sendToGoogleSheet(row);
}

/* ===========================
   DEMOGRAPHICS
=========================== */
function showDemographics(){
  const demographicsContainer = document.getElementById("demographicsQuestionsContainer");
  demographicsContainer.innerHTML = '';

  const responses = {};

  // Question 1: Best Arabic dialect (Text)
  const q1 = createQuestion(
    "What Arabic dialect do you speak the best?",
    createTextInput(responses, "dialect_best")
  );
  demographicsContainer.appendChild(q1);

  // Question 2: Second best dialect (Text)
  const q2 = createQuestion(
    "What Arabic dialect do you speak the second best? (Can be 'none' if you only know one dialect)",
    createTextInput(responses, "dialect_second")
  );
  demographicsContainer.appendChild(q2);

  // Question 3: Ease of understanding other communities (Likert 1-7)
  const q3 = createQuestion(
    "When you speak in Arabic with someone from another community or country where Arabic is spoken, how easy are they to understand?",
    createLikertScale(responses, "understand_other", "Hard to understand", "Easy to understand")
  );
  demographicsContainer.appendChild(q3);

  // Question 4: MSA instruction (Yes/No)
  const q4 = createQuestion(
    "In your formal education, did you receive instruction on how to pronounce Modern Standard Arabic?",
    createYesNoButtons(responses, "msa_instruction")
  );
  demographicsContainer.appendChild(q4);

  // Question 5: Comfort reading MSA with vowels (Likert 1-7)
  const q5 = createQuestion(
    "On the following scale below, please indicate how comfortable you are with reading Modern Standard Arabic using vowels (harakat حَرَكَات).",
    createLikertScale(responses, "msa_vowels", "Not comfortable", "Very comfortable")
  );
  demographicsContainer.appendChild(q5);

  // Question 6: Radio/News difficulty (Stacked Likert 1-7)
  const q6 = createQuestion(
    "If you listen to the radio or read a news broadcast in Modern Standard Arabic, how difficult is it for you to understand?",
    createStackedLikert(responses, "msa_reading", "msa_listening")
  );
  demographicsContainer.appendChild(q6);

  // Next button
  const demographicsNextBtn = document.getElementById("demographicsNextBtn");
  demographicsNextBtn.onclick = () => {
    // Validate all fields
    const allAnswered = responses.dialect_best && responses.dialect_second && responses.understand_other && 
                        responses.msa_instruction && responses.msa_vowels && responses.msa_reading && responses.msa_listening;
    if(!allAnswered){
      alert("Please answer all questions before continuing.");
      return;
    }

    // Send to Google Sheet
    const row = {
      participant_id: State.participantId,
      prolific_id: State.participantId,
      block: "Demographics",
      dialect_best: responses.dialect_best ?? "",
      dialect_second: responses.dialect_second ?? "",
      understand_other: responses.understand_other ?? "",
      msa_instruction: responses.msa_instruction ?? "",
      msa_vowels: responses.msa_vowels ?? "",
      msa_reading: responses.msa_reading ?? "",
      msa_listening: responses.msa_listening ?? "",
      headphone_type: State.headphoneType,
      timestamp_iso: new Date().toISOString(),
    };
    sendToGoogleSheet(row);

    // Go to language demographics
    hide("screen-demographics");
    hide("screen-feedback");
    showLanguageDemographics();
  };

  hide("screen-feedback");
  show("screen-demographics");
}

function createTextInput(responses, key){
  const div = document.createElement('div');
  div.className = 'text-input-field';
  
  const input = document.createElement('input');
  input.type = 'text';
  input.placeholder = 'Enter your answer...';
  input.oninput = () => {
    responses[key] = input.value;
  };
  
  div.appendChild(input);
  return div;
}

function createStackedLikert(responses, readingKey, listeningKey){
  const div = document.createElement('div');
  div.className = 'stacked-likert';
  
  // Reading
  const readingDiv = document.createElement('div');
  readingDiv.className = 'stacked-likert-item';
  
  const readingTitle = document.createElement('div');
  readingTitle.className = 'stacked-likert-item-title';
  readingTitle.textContent = 'Reading';
  readingDiv.appendChild(readingTitle);
  
  const readingButtons = [];
  const readingScale = document.createElement('div');
  readingScale.className = 'likert-scale';
  for(let i = 1; i <= 7; i++){
    const btn = document.createElement('button');
    btn.className = 'likert-btn';
    btn.textContent = i;
    btn.onclick = () => {
      responses[readingKey] = i;
      readingButtons.forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
    };
    readingButtons.push(btn);
    readingScale.appendChild(btn);
  }
  readingDiv.appendChild(readingScale);
  
  const readingLabels = document.createElement('div');
  readingLabels.className = 'likert-labels';
  const readingLeft = document.createElement('span');
  readingLeft.textContent = 'Difficult';
  const readingRight = document.createElement('span');
  readingRight.textContent = 'Easy';
  readingLabels.appendChild(readingLeft);
  readingLabels.appendChild(readingRight);
  readingDiv.appendChild(readingLabels);
  
  div.appendChild(readingDiv);
  
  // Listening
  const listeningDiv = document.createElement('div');
  listeningDiv.className = 'stacked-likert-item';
  
  const listeningTitle = document.createElement('div');
  listeningTitle.className = 'stacked-likert-item-title';
  listeningTitle.textContent = 'Listening';
  listeningDiv.appendChild(listeningTitle);
  
  const listeningButtons = [];
  const listeningScale = document.createElement('div');
  listeningScale.className = 'likert-scale';
  for(let i = 1; i <= 7; i++){
    const btn = document.createElement('button');
    btn.className = 'likert-btn';
    btn.textContent = i;
    btn.onclick = () => {
      responses[listeningKey] = i;
      listeningButtons.forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
    };
    listeningButtons.push(btn);
    listeningScale.appendChild(btn);
  }
  listeningDiv.appendChild(listeningScale);
  
  const listeningLabels = document.createElement('div');
  listeningLabels.className = 'likert-labels';
  const listeningLeft = document.createElement('span');
  listeningLeft.textContent = 'Difficult';
  const listeningRight = document.createElement('span');
  listeningRight.textContent = 'Easy';
  listeningLabels.appendChild(listeningLeft);
  listeningLabels.appendChild(listeningRight);
  listeningDiv.appendChild(listeningLabels);
  
  div.appendChild(listeningDiv);
  return div;
}

/* ===========================
   LANGUAGE DEMOGRAPHICS
=========================== */
function showLanguageDemographics(){
  const container = document.getElementById("demographicsLanguageQuestionsContainer");
  container.innerHTML = '';

  const responses = {};

  // Question 1: Other languages (Text)
  const q1 = createQuestion(
    "What other languages do you speak other than English and Arabic?",
    createTextInput(responses, "other_languages")
  );
  container.appendChild(q1);

  // Questions 2-4: Percentage sliders (must sum to 100)
  const percentageDiv = createPercentageQuestion(responses);
  container.appendChild(percentageDiv);

  // Question 5: Language switching (Likert 1-7)
  const q5 = createQuestion(
    "When you are with people who know the same languages as you, do you often switch back and forth between the languages?",
    createLikertScale(responses, "language_switching", "Stay in one language", "Switch often")
  );
  container.appendChild(q5);

  // Question 6: Family preference (Likert 1-7)
  const q6 = createQuestion(
    "In your family and friend circle, are you encouraged to speak all of your languages or do people tend to prefer a particular language?",
    createLikertScale(responses, "family_preference", "Speak any language", "Prefer one language")
  );
  container.appendChild(q6);

  // Question 7: Age (Text)
  const q7 = createQuestion(
    "What is your age?",
    createTextInput(responses, "age")
  );
  container.appendChild(q7);

  // Question 8: Gender (Text)
  const q8 = createQuestion(
    "What is your gender?",
    createTextInput(responses, "gender")
  );
  container.appendChild(q8);

  // Question 9: Country of residence (Text)
  const q9 = createQuestion(
    "What is your country of residence?",
    createTextInput(responses, "country_of_residence")
  );
  container.appendChild(q9);

  // Next button
  const demographicsLanguageNextBtn = document.getElementById("demographicsLanguageNextBtn");
  demographicsLanguageNextBtn.onclick = () => {
    // Validate all fields
    const allAnswered = responses.other_languages && responses.percent_english !== undefined && 
                        responses.percent_arabic !== undefined && responses.percent_other !== undefined && 
                        responses.language_switching && responses.family_preference && responses.age && responses.gender && responses.country_of_residence;
    
    if(!allAnswered){
      alert("Please answer all questions before continuing.");
      return;
    }

    // Validate percentages sum to 100
    const total = parseInt(responses.percent_english || 0) + parseInt(responses.percent_arabic || 0) + parseInt(responses.percent_other || 0);
    if(total !== 100){
      alert("The three percentage questions must add up to 100%. Current total: " + total);
      return;
    }

    // Send to Google Sheet
    const row = {
      participant_id: State.participantId,
      prolific_id: State.participantId,
      block: "Demographics-Language",
      other_languages: responses.other_languages ?? "",
      percent_english: responses.percent_english ?? "",
      percent_arabic: responses.percent_arabic ?? "",
      percent_other: responses.percent_other ?? "",
      language_switching: responses.language_switching ?? "",
      family_preference: responses.family_preference ?? "",
      age: responses.age ?? "",
      gender: responses.gender ?? "",
      headphone_type: State.headphoneType,
      timestamp_iso: new Date().toISOString(),
    };
    sendToGoogleSheet(row);

    // Go to feedback (final screen before completion)
    hide("screen-demographics-language");
    show("screen-feedback");
  };

  hide("screen-feedback");
  show("screen-demographics-language");
}

function createPercentageQuestion(responses){
  const div = document.createElement('div');
  div.className = 'survey-question';
  
  const label = document.createElement('div');
  label.className = 'survey-question-text';
  label.textContent = 'What percentage of your week is spent using each language?';
  div.appendChild(label);

  const sliderGroup = document.createElement('div');
  sliderGroup.style.display = 'flex';
  sliderGroup.style.flexDirection = 'column';
  sliderGroup.style.gap = '16px';

  // English slider
  const englishDiv = document.createElement('div');
  const englishLabel = document.createElement('div');
  englishLabel.style.fontWeight = '600';
  englishLabel.style.fontSize = '14px';
  englishLabel.textContent = 'English';
  englishDiv.appendChild(englishLabel);
  
  const englishSlider = document.createElement('input');
  englishSlider.type = 'range';
  englishSlider.min = '0';
  englishSlider.max = '100';
  englishSlider.value = '33';
  englishSlider.style.width = '100%';
  
  const englishValue = document.createElement('div');
  englishValue.textContent = '33%';
  englishValue.style.marginTop = '4px';
  englishValue.style.fontWeight = '600';
  englishValue.style.color = '#007acc';
  
  englishSlider.oninput = () => {
    responses.percent_english = parseInt(englishSlider.value);
    englishValue.textContent = englishSlider.value + '%';
    updatePercentageTotal(responses, totalDisplay);
  };
  
  englishDiv.appendChild(englishSlider);
  englishDiv.appendChild(englishValue);
  sliderGroup.appendChild(englishDiv);

  // Arabic slider
  const arabicDiv = document.createElement('div');
  const arabicLabel = document.createElement('div');
  arabicLabel.style.fontWeight = '600';
  arabicLabel.style.fontSize = '14px';
  arabicLabel.textContent = 'Arabic';
  arabicDiv.appendChild(arabicLabel);
  
  const arabicSlider = document.createElement('input');
  arabicSlider.type = 'range';
  arabicSlider.min = '0';
  arabicSlider.max = '100';
  arabicSlider.value = '33';
  arabicSlider.style.width = '100%';
  
  const arabicValue = document.createElement('div');
  arabicValue.textContent = '33%';
  arabicValue.style.marginTop = '4px';
  arabicValue.style.fontWeight = '600';
  arabicValue.style.color = '#007acc';
  
  arabicSlider.oninput = () => {
    responses.percent_arabic = parseInt(arabicSlider.value);
    arabicValue.textContent = arabicSlider.value + '%';
    updatePercentageTotal(responses, totalDisplay);
  };
  
  arabicDiv.appendChild(arabicSlider);
  arabicDiv.appendChild(arabicValue);
  sliderGroup.appendChild(arabicDiv);

  // Other languages slider
  const otherDiv = document.createElement('div');
  const otherLabel = document.createElement('div');
  otherLabel.style.fontWeight = '600';
  otherLabel.style.fontSize = '14px';
  otherLabel.textContent = 'Other Languages';
  otherDiv.appendChild(otherLabel);
  
  const otherSlider = document.createElement('input');
  otherSlider.type = 'range';
  otherSlider.min = '0';
  otherSlider.max = '100';
  otherSlider.value = '34';
  otherSlider.style.width = '100%';
  
  const otherValue = document.createElement('div');
  otherValue.textContent = '34%';
  otherValue.style.marginTop = '4px';
  otherValue.style.fontWeight = '600';
  otherValue.style.color = '#007acc';
  
  otherSlider.oninput = () => {
    responses.percent_other = parseInt(otherSlider.value);
    otherValue.textContent = otherSlider.value + '%';
    updatePercentageTotal(responses, totalDisplay);
  };
  
  otherDiv.appendChild(otherSlider);
  otherDiv.appendChild(otherValue);
  sliderGroup.appendChild(otherDiv);

  // Total display
  const totalDisplay = document.createElement('div');
  totalDisplay.style.fontWeight = '600';
  totalDisplay.style.fontSize = '14px';
  totalDisplay.style.padding = '8px 12px';
  totalDisplay.style.borderRadius = '6px';
  totalDisplay.style.marginTop = '12px';
  totalDisplay.style.textAlign = 'center';
  updatePercentageTotal(responses, totalDisplay);
  sliderGroup.appendChild(totalDisplay);

  div.appendChild(sliderGroup);
  
  // Initialize responses
  responses.percent_english = 33;
  responses.percent_arabic = 33;
  responses.percent_other = 34;

  return div;
}

function updatePercentageTotal(responses, display){
  const total = parseInt(responses.percent_english || 0) + parseInt(responses.percent_arabic || 0) + parseInt(responses.percent_other || 0);
  display.textContent = 'Total: ' + total + '%';
  
  if(total === 100){
    display.className = 'percentage-total-display valid';
  } else {
    display.className = 'percentage-total-display invalid';
  }
}

/* ===========================
   FINISH SCREEN LINKS
=========================== */
document.getElementById("completionCode").textContent = CONFIG.completionCode;
document.getElementById("prolificReturnLink").href = CONFIG.prolificReturnUrl;
</script>

</body>
</html>
